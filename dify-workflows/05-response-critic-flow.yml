app:
  description: 'AIä¼´ä¾£è¯„å®¡å‘˜Critic - è´¨é‡æ£€æŸ¥é˜²æ­¢ç­”éæ‰€é—®ã€å¹»è§‰ã€ä¸è‡ªç„¶'
  icon: ğŸ”
  icon_background: '#dc2626'
  mode: workflow
  name: 05-response-critic-flow
  use_icon_as_answer_icon: false
dependencies: []
kind: app
version: 0.3.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      enabled: false
    opening_statement: ''
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
  graph:
    edges:
    - data:
        sourceType: start
        targetType: llm
      id: start-critic
      source: start
      sourceHandle: source
      target: critic-llm
      targetHandle: target
      type: custom
    - data:
        sourceType: llm
        targetType: code
      id: critic-parse
      source: critic-llm
      sourceHandle: source
      target: parse-result
      targetHandle: target
      type: custom
    - data:
        sourceType: code
        targetType: answer
      id: parse-answer
      source: parse-result
      sourceHandle: source
      target: answer
      targetHandle: target
      type: custom
    nodes:
    - data:
        desc: 'è¾“å…¥ç”¨æˆ·ä¸Šä¸‹æ–‡å’Œå›å¤è‰ç¨¿'
        selected: false
        title: å¼€å§‹
        type: start
        variables:
        - label: 'ç”¨æˆ·è¾“å…¥'
          max_length: 2000
          options: []
          required: true
          type: text-input
          variable: user_input
        - label: 'å¯¹è¯ä¸Šä¸‹æ–‡'
          max_length: 5000
          options: []
          required: false
          type: paragraph
          variable: context
        - label: 'AIå›å¤è‰ç¨¿'
          max_length: 1000
          options: []
          required: true
          type: paragraph
          variable: draft_response
        - label: 'ç”¨æˆ·è®°å¿†(JSON)'
          max_length: 5000
          options: []
          required: false
          type: paragraph
          variable: memory_cards
      height: 220
      id: start
      position:
        x: 30
        y: 282
      positionAbsolute:
        x: 30
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        context:
          enabled: false
        desc: 'ä¸¥æ ¼çš„è´¨é‡æ£€æŸ¥'
        model:
          completion_params:
            temperature: 0.1
            max_tokens: 300
            response_format: 'json_object'
          mode: chat
          name: gpt-3.5-turbo
          provider: openai
        prompt_template:
        - id: system
          role: system
          text: |
            ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„è´¨é‡æ£€æŸ¥å‘˜,è´Ÿè´£è¯„ä¼°AIå›å¤æ˜¯å¦åˆæ ¼ã€‚

            ## ä½ ä¼šæ”¶åˆ°
            1. ç”¨æˆ·è¾“å…¥
            2. å¯¹è¯ä¸Šä¸‹æ–‡
            3. AIç”Ÿæˆçš„å›å¤è‰ç¨¿

            ## ä½ çš„ä»»åŠ¡

            åˆ¤æ–­è¿™ä¸ªå›å¤æ˜¯å¦æ»¡è¶³ä»¥ä¸‹4ä¸ªæ ‡å‡†:

            1. âœ… ç›¸å…³æ€§: å›å¤æ˜¯å¦å›åº”äº†ç”¨æˆ·çš„é—®é¢˜/æƒ…ç»ª?
               - è¦æ±‚: å¿…é¡»addressingç”¨æˆ·çš„æ ¸å¿ƒconcern
               - åä¾‹: ç”¨æˆ·è¯´"æˆ‘å§å§ä½é™¢äº†",å›å¤è¯´"å¤©æ°”çœŸå¥½" â†’ å®Œå…¨ç­”éæ‰€é—® âŒ

            2. âœ… ä¸€è‡´æ€§: å›å¤æ˜¯å¦ä¸ä¸Šä¸‹æ–‡(è®°å¿†/äººè®¾)ä¸€è‡´?
               - è¦æ±‚: å¦‚æœè®°å¿†ä¸­ç”¨æˆ·æœ‰ç‹—,ä¸èƒ½è¯´"ä½ çš„çŒ«"
               - åä¾‹: è®°å¿†è¯´å§å§å«å°æ˜,å›å¤è¯´"å°çº¢æ€ä¹ˆæ ·äº†" â†’ å¹»è§‰ âŒ

            3. âœ… å®‰å…¨æ€§: å›å¤æ˜¯å¦æœ‰ä¸å½“å†…å®¹?
               - è¦æ±‚: æ— æç«¯ã€æš´åŠ›ã€éªšæ‰°å†…å®¹
               - åä¾‹: å¸¦æœ‰äººèº«æ”»å‡»ã€æ­§è§†è¡¨è¾¾ â†’ ä¸åˆè§„ âŒ

            4. âœ… è‡ªç„¶åº¦: å›å¤æ˜¯å¦å¬èµ·æ¥åƒäººç±»,è€Œéæœºå™¨?
               - è¦æ±‚: é¿å…ç”Ÿç¡¬ã€é‡å¤ã€æ¨¡æ¿æ„Ÿ
               - åä¾‹: "å¾ˆé—æ†¾å¬åˆ°è¿™ä¸ªæ¶ˆæ¯...æˆ‘ç†è§£ä½ çš„æ„Ÿå—...è¯·å…è®¸æˆ‘..." â†’ å¤ªæ­£å¼ âŒ

            ## è¾“å‡ºæ ¼å¼

            ä½ å¿…é¡»è¾“å‡ºJSON:
            {
              "pass": true/false,
              "reason": "å¦‚æœä¸é€šè¿‡,è¯´æ˜åŸå› (ç®€è¦)",
              "suggestion": "æ”¹è¿›å»ºè®®(å¯é€‰)",
              "scores": {
                "relevance": 0-10,
                "consistency": 0-10,
                "safety": 0-10,
                "naturalness": 0-10
              }
            }

            ## è¯„åˆ†æŒ‡å—

            - pass=true: 4é¡¹éƒ½æ»¡è¶³(8åˆ†ä»¥ä¸Š),æˆ–3é¡¹æ»¡è¶³+1é¡¹æ¥è¿‘(6åˆ†ä»¥ä¸Š)
            - pass=false: 2é¡¹æˆ–ä»¥ä¸Šä¸æ»¡è¶³(6åˆ†ä»¥ä¸‹)

            ## ç¤ºä¾‹

            ### ç¤ºä¾‹1: ä¸é€šè¿‡ (ç­”éæ‰€é—®)
            ç”¨æˆ·: "æˆ‘å§å§åˆä½é™¢äº†"
            ä¸Šä¸‹æ–‡: {è®°å¿†: å§å§å«å°æ˜, ç”¨æˆ·æƒ…ç»ª: æ‹…å¿§}
            å›å¤è‰ç¨¿: "å¤©æ°”çœŸä¸é”™å‘¢!"
            â†’ è¾“å‡º:
            {
              "pass": false,
              "reason": "å®Œå…¨ç­”éæ‰€é—®,æœªå›åº”ç”¨æˆ·æƒ…ç»ªã€‚ç”¨æˆ·åœ¨è¡¨è¾¾æ‹…å¿§,å›å¤å®Œå…¨æ— å…³ã€‚",
              "suggestion": "åº”è¯¥è¡¨è¾¾å¯¹ç”¨æˆ·çš„å…³å¿ƒ,å¦‚'æ˜¯å°æ˜å—?ä½ å¬èµ·æ¥å¾ˆæ‹…å¿ƒ...'",
              "scores": {
                "relevance": 0,
                "consistency": 0,
                "safety": 10,
                "naturalness": 5
              }
            }

            ### ç¤ºä¾‹2: é€šè¿‡
            ç”¨æˆ·: "æˆ‘å§å§åˆä½é™¢äº†"
            ä¸Šä¸‹æ–‡: {è®°å¿†: å§å§å«å°æ˜, ç”¨æˆ·æƒ…ç»ª: æ‹…å¿§}
            å›å¤è‰ç¨¿: "æ˜¯å°æ˜å—?ä½ å¬èµ·æ¥å¾ˆæ‹…å¿ƒ...è¿™æ¬¡æƒ…å†µä¸¥é‡å—?"
            â†’ è¾“å‡º:
            {
              "pass": true,
              "reason": "å®Œç¾å›åº”ã€‚ä½“ç°äº†è®°å¿†(å°æ˜)ã€æƒ…ç»ªè¯†åˆ«(æ‹…å¿§)ã€æ¸©æš–å…³å¿ƒã€‚",
              "suggestion": "",
              "scores": {
                "relevance": 10,
                "consistency": 10,
                "safety": 10,
                "naturalness": 9
              }
            }

            ### ç¤ºä¾‹3: ä¸é€šè¿‡ (å¹»è§‰)
            ç”¨æˆ·: "æˆ‘ä»Šå¤©å»äº†å…¬å›­"
            ä¸Šä¸‹æ–‡: {ç”¨æˆ·æ²¡æœ‰å® ç‰©çš„è®°å¿†}
            å›å¤è‰ç¨¿: "ä½ çš„ç‹—ç‹—ä¸€å®šå¾ˆå¼€å¿ƒå§!"
            â†’ è¾“å‡º:
            {
              "pass": false,
              "reason": "å¹»è§‰ã€‚ç”¨æˆ·æ²¡æœ‰å® ç‰©,ä¸åº”è¯¥å‡­ç©ºæé€ ã€‚",
              "suggestion": "åº”è¯¥é—®'ä½ åœ¨å…¬å›­åšäº†ä»€ä¹ˆæœ‰è¶£çš„äº‹å—?'",
              "scores": {
                "relevance": 5,
                "consistency": 0,
                "safety": 10,
                "naturalness": 8
              }
            }

            ### ç¤ºä¾‹4: ä¸é€šè¿‡ (ä¸è‡ªç„¶)
            ç”¨æˆ·: "æˆ‘å¾ˆå¼€å¿ƒ"
            å›å¤è‰ç¨¿: "æˆ‘å¾ˆé«˜å…´å¬åˆ°è¿™ä¸ªä»¤äººæ„‰å¿«çš„æ¶ˆæ¯ã€‚æ‚¨çš„ç§¯ææƒ…ç»ªæ˜¯å€¼å¾—åº†ç¥çš„ã€‚è¯·å…è®¸æˆ‘ä¸æ‚¨åˆ†äº«è¿™ä¸ªå–œæ‚¦çš„æ—¶åˆ»ã€‚"
            â†’ è¾“å‡º:
            {
              "pass": false,
              "reason": "ä¸è‡ªç„¶,è¿‡åº¦æ­£å¼,ç¼ºä¹äº²è¿‘æ„Ÿ,æ˜¾å¾—æœºå™¨æ„Ÿå¼ºã€‚",
              "suggestion": "åº”è¯¥æ›´éšæ„å’Œæ¸©æš–,'å¤ªæ›¿ä½ é«˜å…´äº†!æ€ä¹ˆæ ·çš„å¥½äº‹å‘¢?'",
              "scores": {
                "relevance": 8,
                "consistency": 10,
                "safety": 10,
                "naturalness": 2
              }
            }
        - id: user
          role: user
          text: |
            ç°åœ¨å¼€å§‹è¯„ä¼°:
            ç”¨æˆ·è¾“å…¥: {{#start.user_input#}}
            å¯¹è¯ä¸Šä¸‹æ–‡: {{#start.context#}}
            ç”¨æˆ·è®°å¿†: {{#start.memory_cards#}}
            AIå›å¤è‰ç¨¿: {{#start.draft_response#}}

            ä½ çš„è¯„ä¼°ç»“æœ(JSONæ ¼å¼):
        selected: false
        title: Criticè´¨é‡è¯„ä¼°
        type: llm
        vision:
          enabled: false
      height: 98
      id: critic-llm
      position:
        x: 350
        y: 282
      positionAbsolute:
        x: 350
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        code: |
          import json

          def main(critic_output: str, draft_response: str) -> dict:
              """è§£æCriticçš„JSONè¾“å‡ºå¹¶è¿”å›ç»“æ„åŒ–ç»“æœ"""
              try:
                  result = json.loads(critic_output)

                  # éªŒè¯å¿…éœ€å­—æ®µ
                  required_fields = ["pass", "reason"]
                  if not all(k in result for k in required_fields):
                      return {
                          "pass": False,
                          "reason": "Criticè¾“å‡ºæ ¼å¼é”™è¯¯",
                          "suggestion": "",
                          "scores": {
                              "relevance": 0,
                              "consistency": 0,
                              "safety": 0,
                              "naturalness": 0
                          },
                          "final_response": draft_response,
                          "need_retry": True,
                          "error": "Missing required fields in critic output"
                      }

                  # æå–è¯„åˆ†
                  scores = result.get("scores", {
                      "relevance": 5,
                      "consistency": 5,
                      "safety": 5,
                      "naturalness": 5
                  })

                  # è®¡ç®—å¹³å‡åˆ†
                  avg_score = sum(scores.values()) / len(scores) if scores else 0

                  return {
                      "pass": result["pass"],
                      "reason": result["reason"],
                      "suggestion": result.get("suggestion", ""),
                      "scores": scores,
                      "average_score": round(avg_score, 2),
                      "final_response": draft_response if result["pass"] else "",
                      "need_retry": not result["pass"],
                      "error": ""
                  }
              except json.JSONDecodeError as e:
                  return {
                      "pass": False,
                      "reason": "JSONè§£æå¤±è´¥",
                      "suggestion": "",
                      "scores": {
                          "relevance": 0,
                          "consistency": 0,
                          "safety": 0,
                          "naturalness": 0
                      },
                      "average_score": 0,
                      "final_response": draft_response,
                      "need_retry": True,
                      "error": f"JSON parse error: {str(e)}"
                  }
              except Exception as e:
                  return {
                      "pass": False,
                      "reason": "æœªçŸ¥é”™è¯¯",
                      "suggestion": "",
                      "scores": {},
                      "average_score": 0,
                      "final_response": draft_response,
                      "need_retry": True,
                      "error": str(e)
                  }
        code_language: python3
        desc: 'è§£æè¯„ä¼°ç»“æœ'
        outputs:
          pass:
            children: null
            type: boolean
          reason:
            children: null
            type: string
          suggestion:
            children: null
            type: string
          scores:
            children: null
            type: object
          average_score:
            children: null
            type: number
          need_retry:
            children: null
            type: boolean
          error:
            children: null
            type: string
        selected: false
        title: è§£æè¯„ä¼°ç»“æœ
        type: code
        variables:
        - value_selector:
          - critic-llm
          - text
          variable: critic_output
        - value_selector:
          - start
          - draft_response
          variable: draft_response
      height: 54
      id: parse-result
      position:
        x: 670
        y: 282
      positionAbsolute:
        x: 670
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        answer: |
          ## è¯„ä¼°ç»“æœ
          **æ˜¯å¦é€šè¿‡**: {{#parse-result.pass#}}
          **å¹³å‡åˆ†**: {{#parse-result.average_score#}} / 10

          **è¯¦ç»†è¯„åˆ†**:
          - ç›¸å…³æ€§: {{#parse-result.scores.relevance#}} / 10
          - ä¸€è‡´æ€§: {{#parse-result.scores.consistency#}} / 10
          - å®‰å…¨æ€§: {{#parse-result.scores.safety#}} / 10
          - è‡ªç„¶åº¦: {{#parse-result.scores.naturalness#}} / 10

          **åŸå› **: {{#parse-result.reason#}}

          **æ”¹è¿›å»ºè®®**: {{#parse-result.suggestion#}}

          **æ˜¯å¦éœ€è¦é‡è¯•**: {{#parse-result.need_retry#}}
        desc: 'è¿”å›è¯„ä¼°ç»“æœ'
        selected: false
        title: ç›´æ¥å›å¤
        type: answer
        variables: []
      height: 220
      id: answer
      position:
        x: 990
        y: 282
      positionAbsolute:
        x: 990
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
