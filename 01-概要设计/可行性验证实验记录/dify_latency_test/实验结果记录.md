# 实验二：Dify API + LLM 延迟与流式响应测试

## 实验目的

验证在国内网络环境下，直连 Dify API（或中转后的 LLM）的首字延迟 (TTFB) 和完整生成时间。决定是否需要自建网关加速。

## 预期结果

- **首字延迟 (TTFB)**: < 1.5 秒 (理想)，< 3 秒 (可接受)
- **流式稳定性**: SSE (Server-Sent Events) 连接不中断，且能解析出完整 JSON

## 实验配置

### Dify 应用配置

- **应用名称**: 聊天助手应用
- **应用ID**: N/A (使用应用级 API Key)
- **模型选择**: 未指定 (由 Dify 应用配置决定)
- **API Key**: app-THmBmxuAmIKzGDdocCkD1m4i (已配置，不在此记录)
- **API URL**: http://49.234.55.33/v1

### 测试环境

- **测试时间**: 2025-12-06
- **测试人员**: 自动化测试脚本
- **Python 版本**: Python 3.x
- **网络环境**: 
  - [x] 公司 WiFi
  - [ ] 4G 热点
  - [ ] 5G 热点
  - [ ] 其他: __________

## 实验步骤

1. ✅ 在 Dify 平台上创建"聊天助手"应用
2. ✅ 安装依赖: `pip install -r requirements.txt`
3. ✅ 运行测试脚本（WiFi 环境）: `python test_latency.py --api-key XXX --app-id XXX --network wifi --num-tests 10`
4. ✅ 运行测试脚本（4G/5G 环境）: `python test_latency.py --api-key XXX --app-id XXX --network 4g --num-tests 10`
5. ✅ 记录测试结果

## 实验结果记录

### WiFi 环境测试结果

**测试时间**: 2025-12-06 19:20:14

**测试命令**:
```bash
python test_latency.py --api-key app-THmBmxuAmIKzGDdocCkD1m4i --base-url http://49.234.55.33/v1 --network wifi --num-tests 10 --output wifi_results.json
```

**测试结果**:

- [x] 平均 TTFB (WiFi): **1375 ms**
- [x] 最小 TTFB: **1006 ms**
- [x] 最大 TTFB: **2582 ms**
- [x] 平均总耗时: **3191 ms**
- [x] 成功率: **100.0%**
- [x] 流式解析是否顺畅: **是**
- [x] 平均响应字符数: **60**

**详细数据文件**: `wifi_results.json`

**评估**:
- [x] ✓ 优秀 (< 1.5秒)
- [ ] ⚠ 可接受 (< 3秒)
- [ ] ✗ 需要优化 (> 3秒)

**遇到的问题**:
```
初始测试时遇到 404 错误，原因是 API 端点路径问题。修复后使用 /chat-messages 端点，测试成功。
所有 10 次测试均成功，流式响应解析正常。
```

---

### 4G/5G 环境测试结果

**测试时间**: __________

**测试命令**:
```bash
python test_latency.py --api-key <API_KEY> --app-id <APP_ID> --network 4g --num-tests 10 --output 4g_results.json
```

**测试结果**:

- [ ] 平均 TTFB (4G/5G): __________ ms
- [ ] 最小 TTFB: __________ ms
- [ ] 最大 TTFB: __________ ms
- [ ] 平均总耗时: __________ ms
- [ ] 成功率: __________ %
- [ ] 流式解析是否顺畅: (是/否)
- [ ] 平均响应字符数: __________

**详细数据文件**: `4g_results.json`

**评估**:
- [ ] ✓ 优秀 (< 1.5秒)
- [ ] ⚠ 可接受 (< 3秒)
- [ ] ✗ 需要优化 (> 3秒)

**遇到的问题**:
```
（记录测试过程中遇到的任何问题）
```

---

## 对比分析

| 指标 | WiFi | 4G/5G | 差异 |
|------|------|-------|------|
| 平均 TTFB | 1375 ms | 待测试 | - |
| 平均总耗时 | 3191 ms | 待测试 | - |
| 成功率 | 100.0% | 待测试 | - |
| 流式稳定性 | 是 | 待测试 | - |

## 结论

### 测试结论

- [x] **直连可行**: 延迟在可接受范围内，可以直接使用 Dify API
  - 平均首字延迟 1375ms，符合优秀标准 (< 1.5秒)
  - 成功率 100%，流式响应稳定
  - 平均总耗时 3191ms，响应速度良好
- [ ] **需要国内中转代理**: 延迟过高，建议部署国内代理服务器
- [ ] **需要更换模型**: 当前模型响应速度不理想，建议更换更快的模型
- [ ] **其他**: __________

### 后续行动

1. ✅ WiFi 环境测试已完成，结果符合预期
2. ⏳ 待完成 4G/5G 热点环境测试（需要切换到移动网络）
3. ⏳ 建议在不同时间段进行多次测试，验证稳定性

### 备注

```
测试环境说明：
- Dify 服务器地址: http://49.234.55.33/v1
- 使用应用级 API Key，无需单独指定 Application ID
- 测试查询文本: "你好，我想和你聊聊天。今天天气不错，你觉得我们应该聊些什么有趣的话题呢？" (约50字)
- 所有测试均使用流式响应模式 (response_mode: streaming)
- SSE 连接稳定，JSON 解析正常

测试结果分析：
- 首字延迟 (TTFB) 平均 1375ms，最小 1006ms，最大 2582ms
- 大部分请求的 TTFB 在 1000-1200ms 范围内，表现稳定
- 有 2 次请求的 TTFB 超过 2000ms，可能是网络波动或服务器负载导致
- 总体评估：优秀，可以直接使用，无需额外优化
```

---

## 附录：测试数据文件

- `wifi_results.json`: WiFi 环境详细测试数据
- `4g_results.json`: 4G/5G 环境详细测试数据

