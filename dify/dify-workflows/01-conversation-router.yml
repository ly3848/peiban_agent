app:
  description: 'AIä¼´ä¾£æ™ºèƒ½è·¯ç”±å™¨ - æ ¹æ®ç”¨æˆ·è¾“å…¥åˆ¤æ–­åº”è¯¥ä½¿ç”¨å“ªç§å¤„ç†é€šé“(å¿«é€Ÿ/æ™ºèƒ½/VIP)'
  icon: ğŸ§­
  icon_background: '#7c3aed'
  mode: workflow
  name: 01-conversation-router
  use_icon_as_answer_icon: false
dependencies: []
kind: app
version: 0.3.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      enabled: false
    opening_statement: ''
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
  graph:
    edges:
    - data:
        isInIteration: false
        sourceType: start
        targetType: llm
      id: start-llm-router
      source: start
      sourceHandle: source
      target: llm-router
      targetHandle: target
      type: custom
    - data:
        isInIteration: false
        sourceType: llm
        targetType: code
      id: llm-router-code-parser
      source: llm-router
      sourceHandle: source
      target: code-parser
      targetHandle: target
      type: custom
    - data:
        isInIteration: false
        sourceType: code
        targetType: answer
      id: code-parser-answer
      source: code-parser
      sourceHandle: source
      target: answer
      targetHandle: target
      type: custom
    nodes:
    - data:
        desc: 'ç”¨æˆ·è¾“å…¥å’Œä¸Šä¸‹æ–‡ä¿¡æ¯'
        selected: false
        title: å¼€å§‹
        type: start
        variables:
        - label: 'ç”¨æˆ·è¾“å…¥'
          max_length: 2000
          options: []
          required: true
          type: text-input
          variable: user_input
        - label: 'ç”¨æˆ·ID'
          max_length: 100
          options: []
          required: true
          type: text-input
          variable: user_id
        - label: 'æ˜¯å¦VIP'
          options:
          - 'true'
          - 'false'
          required: true
          type: select
          variable: is_vip
        - label: 'å¯¹è¯å†å²(JSON)'
          max_length: 10000
          options: []
          required: false
          type: paragraph
          variable: conversation_history
      height: 220
      id: start
      position:
        x: 30
        y: 282
      positionAbsolute:
        x: 30
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 'åˆ†æç”¨æˆ·æ„å›¾å¹¶è¾“å‡ºè·¯ç”±å†³ç­–'
        model:
          completion_params:
            temperature: 0.3
            max_tokens: 500
            response_format: 'json_object'
          mode: chat
          name: deepseek-chat
          provider: deepseek
        prompt_template:
        - id: system-prompt
          role: system
          text: |
            ## ç³»ç»Ÿè§’è‰²
            ä½ æ˜¯ä¸€ä¸ªå¯¹è¯æ„å›¾è¯†åˆ«ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·è¾“å…¥,åˆ¤æ–­åº”è¯¥ç”¨å“ªç§å¤„ç†æ–¹å¼ã€‚

            ## ä»»åŠ¡
            åˆ†æç”¨æˆ·çš„è¾“å…¥,å¹¶è¾“å‡ºä»¥ä¸‹JSON:
            {
              "route": "fast|smart|vip",
              "intent": "ç®€çŸ­æè¿°ç”¨æˆ·æ„å›¾",
              "confidence": 0.0-1.0,
              "reasoning": "ä¸ºä»€ä¹ˆåšè¿™ä¸ªåˆ¤æ–­"
            }

            ## è·¯ç”±è§„åˆ™ (ä¼˜å…ˆçº§ä»é«˜åˆ°ä½)

            ### è§„åˆ™1: VIPç”¨æˆ·æ£€æµ‹ (æœ€é«˜ä¼˜å…ˆçº§)
            å¦‚æœ ç”¨æˆ·æ˜¯VIPä¸”è¾“å…¥åŒ…å«å¿ƒç†å’¨è¯¢/äº²å¯†æ¨¡å¼å…³é”®è¯:
              â†’ route = "vip"
              â†’ intent = "emotional_coaching" æˆ– "intimacy_mode"
            å…³é”®è¯ç¤ºä¾‹:
              - å¿ƒç†å’¨è¯¢: "æˆ‘å¾ˆç„¦è™‘", "æˆ‘æŠ‘éƒäº†", "æˆ‘æœ‰å¿ƒç†é—®é¢˜"
              - äº²å¯†æ¨¡å¼: [éœ€åœ¨VIP Agentä¸­å®šä¹‰]

            ### è§„åˆ™2: å¤æ‚æ€§è¯„ä¼°
            if è¾“å…¥åŒ…å«ä»¥ä¸‹ç‰¹å¾ â†’ route = "smart":
              - éœ€è¦å¤šæ­¥æ¨ç† (å¦‚: "å¸®æˆ‘è®¡åˆ’...", "æé†’æˆ‘...")
              - éœ€è¦è°ƒç”¨å·¥å…· (å¦‚: "è®¾ç½®æé†’", "æŸ¥è¯¢å¤©æ°”")
              - éœ€è¦è®°å¿†æ£€ç´¢ (å¦‚: "æˆ‘å“¥å“¥å«ä»€ä¹ˆ", "ä½ è®°å¾—...")
              - æœ‰æ˜æ˜¾æƒ…ç»ªå€¾è¯‰ (å¦‚: "æˆ‘å¥½ç´¯", "å¿ƒæƒ…ä¸å¥½")
              - è¾“å…¥é•¿åº¦>30å­— ä¸”åŒ…å«å¤šä¸ªå®ä½“

            ### è§„åˆ™3: ç®€å•é—²èŠ
            else â†’ route = "fast"
            ç‰¹å¾:
              - ç®€å•é—®å€™ ("æ—©å®‰", "æ™šå®‰", "åœ¨å—")
              - å•ä¸€æƒ…ç»ªæ ‡ç­¾ ("å¼€å¿ƒ", "æœ‰ç‚¹çƒ¦")
              - é•¿åº¦<20å­—
              - ä¸éœ€è¦ä¸Šä¸‹æ–‡ç†è§£

            ## è¯„åˆ†é€»è¾‘
            confidence = 0.0-1.0
            - 1.0: éå¸¸ç¡®å®š (å‘½ä¸­å¤šæ¡è§„åˆ™)
            - 0.8+: ç¡®å®š (å‘½ä¸­ä¸»è¦è§„åˆ™)
            - 0.6-0.8: ä¸­ç­‰ (è§„åˆ™å†²çª,éœ€è¦LLMåˆ¤æ–­)
            - <0.6: ä¸ç¡®å®š (éœ€è¦fallbackåˆ°fast)

            ## ç¤ºä¾‹

            ### ä¾‹å­1: ç®€å•é—®å€™
            ç”¨æˆ·: "æ—©å®‰"
            è¾“å‡º:
            {
              "route": "fast",
              "intent": "greeting",
              "confidence": 0.95,
              "reasoning": "ç®€å•é—®å€™,æ— éœ€å¤æ‚å¤„ç†"
            }

            ### ä¾‹å­2: æƒ…ç»ªå€¾è¯‰
            ç”¨æˆ·: "æˆ‘æœ€è¿‘å·¥ä½œå‹åŠ›å¾ˆå¤§,ç¡çœ è´¨é‡ä¹Ÿä¸‹é™äº†,ä½ è¯´æˆ‘åº”è¯¥æ€ä¹ˆåŠ?"
            è¾“å‡º:
            {
              "route": "smart",
              "intent": "emotional_support_with_advice",
              "confidence": 0.9,
              "reasoning": "åŒ…å«æƒ…ç»ªå€¾è¯‰(å‹åŠ›å¤§)å’Œæ±‚åŠ©(æ€ä¹ˆåŠ),éœ€è¦å…±æƒ…+å»ºè®®,å±å¤æ‚ä»»åŠ¡"
            }

            ### ä¾‹å­3: è®°å¿†æŸ¥è¯¢
            ç”¨æˆ·: "æˆ‘é‚£ä¸ªåœ¨åŒ»é™¢å·¥ä½œçš„æœ‹å‹å«ä»€ä¹ˆåå­—æ¥ç€?"
            è¾“å‡º:
            {
              "route": "smart",
              "intent": "memory_retrieval",
              "confidence": 0.85,
              "reasoning": "éœ€è¦è°ƒç”¨è®°å¿†åº“æŸ¥è¯¢,å±äºsmartèŒƒç•´"
            }

            ### ä¾‹å­4: VIPå¿ƒç†å’¨è¯¢
            ç”¨æˆ·: "æˆ‘æœ€è¿‘æœ‰ç‚¹æŠ‘éƒ,æ€»æ˜¯æ²¡æœ‰ç²¾åŠ›..."
            è¾“å‡º:
            {
              "route": "vip",
              "intent": "emotional_coaching",
              "confidence": 0.8,
              "reasoning": "ç”¨æˆ·æ˜¯VIP,è¾“å…¥åŒ…å«å¿ƒç†ç›¸å…³è¯æ±‡(æŠ‘éƒ),åº”è·¯ç”±åˆ°æƒ…æ„Ÿæ•™ç»ƒ"
            }
        - id: user-prompt
          role: user
          text: |
            ç°åœ¨,åˆ†æä»¥ä¸‹ç”¨æˆ·è¾“å…¥:
            ç”¨æˆ·è¾“å…¥: {{#start.user_input#}}
            ç”¨æˆ·ä¿¡æ¯:
            - ç”¨æˆ·ID: {{#start.user_id#}}
            - æ˜¯å¦VIP: {{#start.is_vip#}}
            - å¯¹è¯å†å²: {{#start.conversation_history#}}

            è¾“å‡ºJSON:
        selected: false
        title: è·¯ç”±å†³ç­–LLM
        type: llm
        vision:
          configs:
            detail: high
          enabled: false
      height: 98
      id: llm-router
      position:
        x: 350
        y: 282
      positionAbsolute:
        x: 350
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        code: |
          import json

          def main(llm_output: str) -> dict:
              """è§£æLLMè¾“å‡ºçš„JSONå¹¶è¿”å›è·¯ç”±ç»“æœ"""
              try:
                  result = json.loads(llm_output)

                  # éªŒè¯å¿…éœ€å­—æ®µ
                  if not all(k in result for k in ["route", "intent", "confidence", "reasoning"]):
                      return {
                          "route": "fast",
                          "intent": "error",
                          "confidence": 0.5,
                          "reasoning": "è§£æå¤±è´¥,ä½¿ç”¨é»˜è®¤fastè·¯ç”±",
                          "error": "Missing required fields"
                      }

                  # éªŒè¯routeå€¼
                  if result["route"] not in ["fast", "smart", "vip"]:
                      result["route"] = "fast"
                      result["reasoning"] += " (invalid route, fallback to fast)"

                  # å¦‚æœconfidence<0.6, é™çº§åˆ°fast
                  if result["confidence"] < 0.6:
                      result["route"] = "fast"
                      result["reasoning"] += " (low confidence, fallback to fast)"

                  return {
                      "route": result["route"],
                      "intent": result["intent"],
                      "confidence": result["confidence"],
                      "reasoning": result["reasoning"]
                  }
              except Exception as e:
                  return {
                      "route": "fast",
                      "intent": "error",
                      "confidence": 0.5,
                      "reasoning": "JSONè§£æå¤±è´¥,ä½¿ç”¨é»˜è®¤fastè·¯ç”±",
                      "error": str(e)
                  }
        code_language: python3
        desc: 'è§£æLLMè¿”å›çš„JSONå¹¶åšfallbackå¤„ç†'
        outputs:
          route:
            children: null
            type: string
          intent:
            children: null
            type: string
          confidence:
            children: null
            type: number
          reasoning:
            children: null
            type: string
        selected: false
        title: JSONè§£æå™¨
        type: code
        variables:
        - value_selector:
          - llm-router
          - text
          variable: llm_output
      height: 54
      id: code-parser
      position:
        x: 670
        y: 282
      positionAbsolute:
        x: 670
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        answer: |
          è·¯ç”±ç»“æœ:
          - è·¯ç”±é€šé“: {{#code-parser.route#}}
          - ç”¨æˆ·æ„å›¾: {{#code-parser.intent#}}
          - ç½®ä¿¡åº¦: {{#code-parser.confidence#}}
          - åˆ¤æ–­ç†ç”±: {{#code-parser.reasoning#}}
        desc: 'è¿”å›è·¯ç”±å†³ç­–ç»“æœ'
        selected: false
        title: ç›´æ¥å›å¤
        type: answer
        variables: []
      height: 143
      id: answer
      position:
        x: 990
        y: 282
      positionAbsolute:
        x: 990
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
