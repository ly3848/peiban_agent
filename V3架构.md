# AI伴侣V3架构设计方案

## 需求分析与优化方向

### PRD核心需求梳理

1. **多角色情感支持** - 需要角色切换+独立记忆库
2. **情绪识别** - 文本语义+语音分析的多模态情绪理解
3. **长期记忆引擎** - 知识图谱存储关键事件
4. **人格定制** - 10种定位+16种MBTI模板
5. **多模态交互** - 文本/语音/视频(2.5D/3D)

### V2架构的不足

1. **过度工程化** - 微服务拆分过细，单人MVP不需要
2. **记忆系统薄弱** - 缺少知识图谱和结构化记忆
3. **情绪识别缺失** - 没有独立的情绪分析模块
4. **角色系统简陋** - 未体现多人格切换机制

## V3优化架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Flutter Client                         │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │
│  │  Chat UI │ │ Voice UI │ │Avatar 3D │ │ Settings │       │
│  └─────┬────┘ └─────┬────┘ └─────┬────┘ └─────┬────┘       │
│        │            │             │             │           │
│        └────────────┴─────────────┴─────────────┘           │
│                         │                                   │
│              ┌──────────▼──────────┐                        │
│              │   Unified Gateway   │                        │
│              │   (API Aggregator)  │                        │
│              └──────────┬──────────┘                        │
└─────────────────────────┼───────────────────────────────────┘
                          │
          ┌─────────────────┼─────────────────┐
          │                 │                 │
┌─────────▼────────┐ ┌─────▼──────┐ ┌─────────▼────────┐
│ Conversation     │ │  Emotion   │ │   Memory        │
│ Orchestrator     │ │  Analyzer  │ │   Manager       │
│                  │ │            │ │                 │
│ • 会话编排       │ │ • 文本情绪 │ │ • 事实库        │
│ • 角色上下文     │ │ • 语音情绪 │ │ • 知识图谱      │
│ • 流式响应       │ │ • 情绪标签 │ │ • 时间线        │
└─────────┬────────┘ └─────┬──────┘ └─────────┬────────┘
          │                 │                 │
          └─────────────────┼─────────────────┘
                            │
                    ┌───────▼───────┐
                    │   LLM Gateway │
                    │               │
                    │ • 模型路由    │
                    │ • Prompt模板  │
                    │ • 人格注入    │
                    │ • 安全过滤    │
                    └───────┬───────┘
                            │
          ┌─────────────────┼─────────────────┐
          │                 │                 │
┌─────────▼────────┐ ┌─────▼──────┐ ┌─────────▼────────┐
│  GPT-4o/         │ │  ASR/TTS   │ │   Vector DB     │
│  DeepSeek-V3     │ │  Services  │ │   (Milvus)      │
└──────────────────┘ └────────────┘ └──────────────────┘
```

## 核心模块说明

### 1. Conversation Orchestrator (会话编排器)

```python
# 核心职责
class ConversationOrchestrator:
    """
    统一管理对话流程：
    1. 加载当前角色人格模板
    2. 注入用户记忆上下文
    3. 调用情绪分析结果
    4. 路由到合适的LLM
    5. 流式返回响应
    """
    def process(self, user_input, role_id, session_id):
        # 获取角色配置
        persona = self.role_manager.get_persona(role_id)

        # 检索相关记忆 (向量检索Top-K)
        memories = self.memory_manager.retrieve(user_input, role_id)

        # 情绪分析
        emotion = self.emotion_analyzer.analyze(user_input)      

        # 构建Prompt
        prompt = self.build_prompt(persona, memories, emotion)

        # LLM调用
        return self.llm_gateway.stream_chat(prompt, session_id)
```

### 2. Emotion Analyzer (情绪分析器)

```python
class EmotionAnalyzer:
    """
    多模态情绪识别：
    1. 文本语义分析 (关键词+句式)
    2. 语音特征分析 (音调+停顿+语速)
    3. 融合输出7种微情绪标签
    """
    def analyze(self, text=None, audio=None):
        emotions = []

        # 文本情绪
        if text:
            text_emotion = self.text_classifier(text)
            emotions.append(text_emotion)

        # 语音情绪
        if audio:
            voice_emotion = self.voice_analyzer(audio)
            emotions.append(voice_emotion)

        # 加权融合
        return self.fuse_emotions(emotions)
```

### 3. Memory Manager (记忆管理器)

```python
class MemoryManager:
    """
    三层记忆架构：
    1. 短期记忆 - Redis (当前会话)
    2. 长期记忆 - Vector DB (事实/偏好)
    3. 知识图谱 - Neo4j (关系/事件)

    每个角色独立记忆库
    """
    def store(self, content, role_id, memory_type):
        # 提取关键信息
        entities = self.extract_entities(content)

        # 存储向量
        self.vector_db.insert(embedding, metadata)

        # 更新图谱
        if memory_type == "milestone":
            self.graph_db.add_event(entities, timestamp)

    def retrieve(self, query, role_id, top_k=5):
        # 向量检索
        results = self.vector_db.search(query, role_id, top_k)

        # 图谱增强
        enhanced = self.graph_db.expand_context(results)

        return enhanced
```

### 4. Role Manager (角色管理器)

```python
class RoleManager:
    """
    管理10种人格定位 + 16种MBTI模板
    动态生成System Prompt
    """
    PERSONA_TEMPLATES = {
        "青梅竹马": {
            "traits": ["亲切", "nostalgic", "protective"],       
            "speech_style": "轻松随意，偶尔开玩笑",
            "boundary": ["不涉及成人内容", "保持纯真"]
        },
        "温柔御姐": {
            "traits": ["成熟", "包容", "智慧"],
            "speech_style": "温柔体贴，语速适中",
            "boundary": ["VIP解锁亲密模式"]
        }
        # ... 其他8种
    }

    def get_system_prompt(self, role_id, mbti="INFJ"):
        template = self.PERSONA_TEMPLATES[role_id]
        mbti_traits = self.MBTI_MAP[mbti]

        return f"""
        你是一个{template['traits']}的{role_id}角色。
        性格特征：{mbti_traits}
        说话风格：{template['speech_style']}
        边界：{template['boundary']}

        用户记忆摘要：{self.memory_manager.get_summary()}        
        """
```

## 与V2对比的优化点

| 维度    | V2          | V3               |
|-------|-------------|------------------|
| 服务拆分  | 7个微服务       | 3个核心模块           |
| 记忆系统  | 单一Vector DB | Vector DB + 知识图谱 |
| 情绪识别  | 后置分析        | 前置独立模块           |
| 角色切换  | 未明确         | 独立记忆库+Prompt模板   |
| 部署复杂度 | K8s集群       | 单体应用+外部服务        |

## 技术栈建议

### 后端 (Python FastAPI)

- **FastAPI** (统一网关)
- **SQLAlchemy** (关系数据)
- **Milvus/Qdrant** (向量检索)
- **Neo4j** (知识图谱)
- **Redis** (会话缓存)

### 前端 (Flutter)

- **flutter_bloc** (状态管理)
- **dio** (网络请求)
- **flame** (3D渲染引擎)
- **speech_to_text** (语音识别)

### AI服务

- **OpenAI GPT-4o** (主模型)
- **DeepSeek-V3** (备用)
- **Azure Speech Services** (TTS/ASR)
- **本地情绪分类器** (DistilBERT微调)

## MVP实现优先级

### Phase 0 (4周) - 核心验证

- Conversation Orchestrator基础框架
- 单一LLM集成(GPT-4o)
- 文本情绪分析(规则+简单模型)
- 短期记忆(Redis)

### Phase 1 (12周) - P0功能

- 3种基础角色模板
- 语音TTS/ASR集成
- Vector DB记忆检索
- Flutter UI (文本+语音)

### Phase 2 (12周) - P1扩展

- 10种人格+16种MBTI
- 知识图谱集成
- 2.5D Avatar
- VIP付费功能

## 关键代码示例(最小化)

```python
# main.py - 统一入口
from fastapi import FastAPI
from modules.orchestrator import ConversationOrchestrator        
from modules.emotion import EmotionAnalyzer
from modules.memory import MemoryManager

app = FastAPI()
orchestrator = ConversationOrchestrator()

@app.post("/chat")
async def chat(message: str, role_id: str):
    return await orchestrator.process(message, role_id)
```