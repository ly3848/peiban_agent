好的，这是进入开发编码前最重要的\*\*《AI伴侣 APP 详细设计说明书 (Detailed Design Document)》\*\*。

这份文档将上一阶段的《系统架构 Canvas》和《技术实施规格书》进一步**颗粒化**，细化到**具体的时序逻辑、数据库字段定义和 API 接口参数**。它将作为后端写代码、前端接接口的直接依据。

-----

# 📘 AI伴侣 APP 详细设计说明书 (MVP版)

**版本**: v1.0
**状态**: 待开发 (Ready for Dev)
**架构基准**: Flutter + Python Middleware + Dify + Supabase

-----

## 1\. 核心业务流程详细设计 (Detailed Business Flows)

### 1.1 角色唤醒（创建）流程

**核心逻辑**：用户通过“AI绘图”生成形象，通过“MBTI测试”生成人设，两者结合存入数据库，不涉及 Dify 动态创建 App。

```mermaid
sequenceDiagram
    participant User as 👤 用户
    participant App as 📱 Flutter
    participant API as 🐍 Python API
    participant GenAI as 🎨 生图服务 (SD/MJ)
    participant DB as 💾 Supabase (Roles)

    Note over User, App: 步骤 1: 形象构建
    User->>App: 输入描述 "粉色头发的猫耳娘"
    App->>API: POST /roles/generate-avatar {prompt}
    API->>GenAI: 调用 Text-to-Image API
    GenAI-->>API: 返回图片 URL
    API-->>App: 返回 URL
    App->>User: 展示预览图 (用户确认)

    Note over User, App: 步骤 2: 灵魂注入
    User->>App: 完成 MBTI 测试 (结果: ENFP)
    App->>API: POST /roles/generate-persona {mbti: "ENFP", tags: ["活泼"]}
    API->>API: 内部拼装 System Prompt 模板
    API-->>App: 返回生成的 "详细人设文本"
    
    Note over User, App: 步骤 3: 绑定轨道与保存
    User->>App: 选择轨道 "恋爱伴侣" + 填写名称
    App->>API: POST /roles {name, avatar_url, persona, category='love'}
    API->>DB: INSERT into roles
    DB-->>API: Success (role_id)
    API-->>App: 创建成功，进入聊天
```

### 1.2 核心聊天流转 (三轨制路由 + 动作解析)

**核心逻辑**：Python 中台作为“总调度”，负责鉴权、路由、计费、动作指令注入。

```mermaid
sequenceDiagram
    participant User as 👤 用户
    participant App as 📱 Flutter (Live2D)
    participant API as 🐍 Python Middleware
    participant DB as 💾 Supabase
    participant Dify as 🧠 Dify (Love/CBT/Pet)

    User->>App: 发送 "我好难过" (当前角色: 林医生/CBT)
    App->>API: POST /chat/completions (Stream) <br/>{role_id, message}
    
    activate API
    API->>DB: 查询角色类型 & 用户关系
    DB-->>API: category='cbt', intimacy=10
    
    Note over API: 路由逻辑: CBT模式 -> 安全检查
    API->>API: 正则匹配危机词 (自杀等) -> 未命中
    
    API->>DB: RAG检索: 获取最近5条记忆
    DB-->>API: [记忆片段...]
    
    API->>Dify: 调用 Dify-CBT App <br/>inputs={memory, query}
    
    loop 流式响应 (SSE)
        Dify-->>API: "抱" (Chunk 1)
        API-->>App: "抱"
        
        Dify-->>API: "抱你..." (Chunk 2)
        API->>API: 情感分析: 检测到安慰意图
        API-->>App: "抱你..." + [Action: Hug]
        
        App->>User: 显示文字 + Live2D播放拥抱动作
    end
    deactivate API
    
    API->>DB: 异步写入 chat_messages 表
```

### 1.3 异步记忆总结 (定期任务)

**核心逻辑**：不阻塞用户聊天，后台 Celery 慢慢跑。

```mermaid
sequenceDiagram
    participant Scheduler as ⏰ APScheduler
    participant Worker as 👷 Celery Worker
    participant DB as 💾 Supabase
    participant LLM as 🧠 Cheap LLM (GPT-4o-mini)

    Scheduler->>Worker: 触发任务: summarize_daily_memories
    Worker->>DB: 查询今日活跃且未总结的会话
    DB-->>Worker: 返回 raw_chat_logs
    
    loop 每个用户/角色对
        Worker->>LLM: 发送对话记录，请求生成摘要
        LLM-->>Worker: 返回 "用户今天被老板骂了，心情低落"
        
        Worker->>LLM: 请求 Embedding (向量化)
        LLM-->>Worker: 返回 Vector [0.1, 0.5, ...]
        
        Worker->>DB: INSERT into memories (content, vector)
        Worker->>DB: UPDATE chat_messages set is_summarized=true
    end
```

-----

## 2\. 数据库设计 (Database Schema)

基于 **Supabase (PostgreSQL)**。

### 2.1 `roles` (角色配置表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | uuid | 主键 |
| `creator_id` | uuid | 创建者ID (NULL为系统角色) |
| `name` | text | 角色名 |
| `avatar_url` | text | 2D立绘图片地址 |
| `category` | enum | **核心字段**: `'love'`, `'cbt'`, `'pet'` |
| `prompt_config` | jsonb | 存储MBTI、口头禅、背景故事。结构：`{"mbti": "INTJ", "bio": "..."}` |
| `safety_level` | int | 风控等级 (1:全年龄, 18:成人) |
| `is_public` | bool | 是否公开可见 |

### 2.2 `user_role_relations` (关系状态表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | uuid | 主键 |
| `user_id` | uuid | 外键 -\> profiles.id |
| `role_id` | uuid | 外键 -\> roles.id |
| `intimacy_score` | int | 好感度数值 (0-10000) |
| `relationship_stage` | enum | `'stranger'`, `'friend'`, `'crush'`, `'lover'` |
| `last_interact_at` | timestamp | 上次聊天时间 (用于触发主动关怀) |

### 2.3 `memories` (记忆向量表)

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | uuid | 主键 |
| `user_id` | uuid | 所属用户 |
| `role_id` | uuid | 所属角色 |
| `content` | text | 记忆摘要文本 |
| `embedding` | vector(1536) | **PGVector 向量数据** |
| `created_at` | timestamp | 记忆形成时间 |

-----

## 3\. API 接口定义 (Interface Definition)

### 3.1 聊天接口 (SSE 流式)

  * **URL**: `POST /api/v1/chat/completions`
  * **Auth**: Bearer Token (Supabase JWT)
  * **Request Body**:
    ```json
    {
      "role_id": "uuid-xxx",
      "message": "今晚我想看点不一样的",
      "mode": "text" // 或 "voice"
    }
    ```
  * **Response (SSE Stream)**:
    ```text
    data: {"type": "text", "content": "那..."}
    data: {"type": "text", "content": "得先关灯哦。"}
    data: {"type": "action", "payload": {"motion": "shy_blush", "voice_url": "http://..."}}
    data: [DONE]
    ```

### 3.2 角色相关接口

  * **创建角色**: `POST /api/v1/roles`
      * Body: `{name, category, prompt_config, ...}`
  * **生成头像**: `POST /api/v1/roles/gen-avatar`
      * Body: `{prompt: "银发御姐"}` -\> Return: `{url: "http://..."}`
  * **查询角色详情**: `GET /api/v1/roles/{id}`
      * Return: 包含 `category` 和当前用户的 `intimacy_score`。

-----

## 4\. 架构一致性自检 (Self-Check)

| 检查项 | 状态 | 说明 |
| :--- | :--- | :--- |
| **是否符合三轨制业务？** | ✅ | 数据库 `category` 字段和 API 路由逻辑已包含此设计。 |
| **是否支持 VIP/双重锁？** | ✅ | 聊天接口流程中包含了 `intimacy` 和 `is_vip` 的检查步骤。 |
| **是否符合 MVP 架构？** | ✅ | 仅依赖 Supabase 和 Dify，Python 只做胶水逻辑，无过度设计。 |
| **是否支持 Live2D？** | ✅ | SSE 协议中专门定义了 `action` 事件用于驱动前端动画。 |
| **是否支持记忆？** | ✅ | 设计了 `memories` 向量表和异步总结 Worker。 |

